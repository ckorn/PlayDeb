#!/usr/bin/make -f

%:
	dh $@ --sourcedirectory=src

override_dh_auto_clean:
	dh_auto_clean
	make -C src clean-enet
	make -C src/enet/ distclean

override_dh_auto_build:
	dh_auto_build -- client server cube2font
	install -d debian/tmp/usr/share/icons/hicolor/16x16/apps \
			debian/tmp/usr/share/icons/hicolor/32x32/apps \
			debian/tmp/usr/share/icons/hicolor/48x48/apps \
			debian/tmp/usr/share/icons/hicolor/64x64/apps \
			debian/tmp/usr/share/icons/hicolor/128x128/apps \
			debian/tmp/usr/share/pixmaps
	convert 'src/redeclipse.ico[0]' \
		debian/tmp/usr/share/icons/hicolor/16x16/apps/redeclipse.png
	convert 'src/redeclipse.ico[1]' \
		debian/tmp/usr/share/icons/hicolor/32x32/apps/redeclipse.png
	convert 'src/redeclipse.ico[1]' \
		debian/tmp/usr/share/pixmaps/redeclipse.xpm
	convert -resize 48x48 'src/redeclipse.ico[2]' \
		debian/tmp/usr/share/icons/hicolor/48x48/apps/redeclipse.png
	convert 'src/redeclipse.ico[2]' \
		debian/tmp/usr/share/icons/hicolor/64x64/apps/redeclipse.png
	convert 'src/redeclipse.ico[3]' \
		debian/tmp/usr/share/icons/hicolor/128x128/apps/redeclipse.png

override_dh_strip:
	dh_strip -predeclipse --dbg-package=redeclipse-dbg
	dh_strip -predeclipse-server --dbg-package=redeclipse-server-dbg
	dh_strip

override_dh_prep:
	dh_prep --exclude=debian/tmp

override_dh_auto_install:
	dh_auto_install --exclude="license.txt"

URL=https://redeclipse.svn.sourceforge.net/svnroot/redeclipse
REV=$(shell dpkg-parsechangelog | sed -rne 's,^Version: .*[+~]svn([0-9]+).*,\1,p')
VER=$(shell dpkg-parsechangelog | sed -rne 's,^Version: ([^-]+).*,\1,p')
DIR=redeclipse-$(VER).orig
TARBALL=redeclipse_$(VER).orig.tar.gz
get-orig-source:
	rm -rf $(DIR)
	svn -q export -r $(REV) $(URL) $(DIR)
	cd $(DIR)
	rm -rf $(DIR)/src/include/
	rm -rf $(DIR)/src/xcode/
	rm -rf $(DIR)/src/lib/
	rm -rf $(DIR)/src/site/
	rm -rf $(DIR)/bin/
	rm -f $(DIR)/data/fonts/akashi.ttf
	GZIP=--best tar -cz --owner root --group root --mode a+rX \
		-f $(TARBALL) $(DIR)
	rm -rf $(DIR)
